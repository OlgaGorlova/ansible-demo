---
# - name: Remove file in /tmp/dp
#   file:
#     path: "/tmp/dp"
#     state: absent
#   become: yes

# - name: Create dir /tmp/dp
#   file:
#     path: "/tmp/dp/"
#     state: absent
#     mode: "0775"
#   become: yes


- name: Copy file
  copy:
    src: files/data.json
    dest: "/tmp/dp/data.json"
  become: yes

- name: Read json
  slurp:
    src: "/tmp/dp/data.json"
  register: data_file
  become: yes

- name: Covert JSON
  set_fact:
    data: "{{ data_file['content'] | b64decode | from_json }}"
  become: yes

# - name: Extract one dp
#   set_fact:
#     dp: "{{ data.resources | selectattr('dp3', 'defined') | map(attribute='dp3') | list }}"
#   become: yes

- name: Load variables from JSON
  include_vars:
    file: files/data.json

- name: Display sources
  debug:
    var: sources
  become: yes

- name: Run task file only for sources that are enabled
  include_tasks: tasks/01_flow.yml
  loop: "{{ sources | map('dict2items') | map('first') | list }}"
  loop_control:
    loop_var: source
  when: source.value.skip_generic_flow | default("no") == "no"
  vars:
    dp: "{{ source.value }}"
    dp_name: "{{ source.key }}"


# - name: Display dp
#   debug:
#     var: dp
#   become: yes

# - name: Display dp path
#   debug:
#     msg: "{{ dp[0].path }}"
#   become: yes

# - name: Set dp vars
#   set_fact:
#     path: "{{ dp[0].path }}"
#     account: "{{ dp[0].account }}"

# - name: Debug path and account
#   debug:
#     msg:
#       - "path = {{ path }}"
#       - "account = {{ account }}"


# - name: Display dp details
#   ansible.builtin.shell: |
#     echo "path: {{ path }}"
#     echo "account: {{ account }}"
#   when:
#     - dp is defined

# - name: Display dp details via shell
#   shell: |
#     echo "PATH={{ path }}"
#     echo "ACCOUNT={{ account }}"
#   register: dp_shell_output
#   vars:
#     path: "{{ dp[0].path }}"
#     account: "{{ dp[0].account }}"
#   become: yes

# - name: Show captured shell output
#   debug:
#     var: dp_shell_output.stdout_lines
